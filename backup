#! /usr/bin/env python
import gtk, pygtk, sys, argparse, time, pynotify, os, signal
from subprocess import call

heirarchy = ['hourly','daily','weekly','monthly']
retention = [24,7,4,12]

def notification(string,icon):
	n = pynotify.Notification("Backup",string,icon)
	n.set_urgency(pynotify.URGENCY_CRITICAL)
	n.show()
	return

def cycle(loc):
	if loc > 3 or loc < 0:
		return

	last = 0
	try:
		f = open('/media/WD/Backups/kevin/.hist','r+')
		last = int(f.readlines()[loc].strip())
	except IOError as e:
		notification('Could not read file: I/O error ({0}): {1}'.format(e.errno, e.strerror),'dialog-error')
	except ValueError:
		notification('Error reading history file: incorrect input for integer.','dialog-error')

	else:
		if last == retention[loc]-1:
			cycle(loc+1)
			f.write('0')
		else:
			call(['rsnapshot',heirarchy[loc]])
			f.write(str(last+1))
		f.close()
	return

def confirm():
	notification(action.title() + ' backup is scheduleded to run in two minutes. Please ensure that the backup device is connected.','dialog-warning')

	f = open('/tmp/backup.pid','w')
	f.write(str(os.getpid()))
	f.close()

	time.sleep(120)


	if (os.path.exists('/media/WD/Backups/kevin')):
		notification(action.title() + ' backup is now running. Please do not remove backup device.','dialog-warning')
		os.rename('/tmp/backup.pid','/tmp/backup_lock.pid')
		return

	dialog_response = 0
	dialog = gtk.MessageDialog(None, gtk.DIALOG_MODAL,\
		gtk.MESSAGE_QUESTION, gtk.BUTTONS_YES_NO,\
		action.title() + ' backup is scheduleded to run.' +\
		' Is the backup device mounted at /media/WD?')

	dialog_response = dialog.run()
	dialog.destroy()

	if dialog_response == -8 and os.path.exists('/media/WD/Backups/kevin'):
		notification(action.title() + ' backup is now running. Please do not remove backup device.','dialog-warning')
		os.rename('/tmp/backup.pid','/tmp/backup_lock.pid')
		return
	else:
		time.sleep(2)
		dialog = gtk.MessageDialog(None,0,gtk.MESSAGE_INFO,gtk.BUTTONS_OK_CANCEL,'Please mount the device now.')
		dialog_response = dialog.run()
		dialog.destroy()
		print dialog_response
		if dialog_response == -5 and os.path.exists('/media/WD/Backups/kevin'):
			notification(action.title() + ' backup is now running. Please do not remove backup device.','dialog-warning')
			os.rename('/tmp/backup.pid','/tmp/backup_lock.pid')
			return
		else:
			notification(action.title() + ' backup failed: unable to locate backup device. Please try again later.','dialog-warning')
			exit()

pynotify.init('Backup')
parser = argparse.ArgumentParser()
parser.add_argument('action',action='store')

action = parser.parse_args(sys.argv[1:]).__dict__['action']

if action in heirarchy:
	confirm()
	cycle(heirarchy.find(action))

elif action == 'test':
	print 'testing...'
	confirm()

elif action == 'kill':
	print 'killing...'
	if os.path.exists('/tmp/backup.pid'):
		os.kill(int(open('/tmp/backup.pid').read().strip()),signal.SIGHUP)
		notification('The pending backup has been cancelled.','dialog-info')
		exit()
	elif os.path.exists('/tmp/backup_lock.pid'):
		notification('Backup is already in progress. Please do not interrupt the process.','dialog-warning')
		exit()
	else:
		print 'Process not found.'
		exit()

else:
	print 'Invalid option.'
	exit()

notification(action.title() + " backup is complete.",'dialog-info')
os.remove('/tmp/backup.pid')
